#############################################
#        PRÁCTICA 1 - CONFIGURACIÓN NFS     #
#############################################

############### SERVIDOR NFS ################

# Instalar el servidor NFS
sudo apt install nfs-kernel-server -y

# Crear carpeta OS3 dentro del HOME del usuario
mkdir /home/miguel1/OS3

# Entrar a la carpeta OS3
cd /home/miguel1/OS3

# Mostrar contenido (debe estar vacía antes de crear archivos)
ls

# Crear 100 archivos ADRIAN1.txt hasta ADRIAN100.txt
touch ADRIAN{1..100}.txt

# Editar la configuración de NFS
sudo nano /etc/exports

# → Agregar esta línea dentro del archivo:
# /home/miguel1/OS3 192.168.16.0/24(rw,sync,no_subtree_check)

# Aplicar exportaciones configuradas
sudo exportfs -a

# Ver exportaciones activas
sudo exportfs -v

# Reiniciar el servicio NFS
sudo systemctl restart nfs-kernel-server

# Ver la ruta actual solo para validar ubicación
pwd


############### CLIENTE NFS #################

# Instalar el cliente NFS
sudo apt install nfs-common -y

# Crear carpeta donde se montará el recurso NFS
mkdir /home/miguel2/CARPETA_DESTINO

# Montar carpeta compartida desde el servidor
# (IP del servidor NFS: 192.168.100.57)
sudo mount 192.168.100.57:/home/miguel1/OS3 /home/miguel2/CARPETA_DESTINO

# Verificar que se montaron los archivos
ls /home/miguel2/CARPETA_DESTINO

# Entrar al directorio montado
cd /home/miguel2/CARPETA_DESTINO

# Editar un archivo para probar escritura
nano ADRIAN99.txt


############ SERVIDOR – VERIFICACIÓN ##########

# Verificar desde el servidor que el archivo se editó correctamente
cat /home/miguel1/OS3/ADRIAN99.txt


############ MONTAJE AUTOMÁTICO (CLIENTE) ############

# Editar fstab para montar el recurso automáticamente al arrancar
sudo nano /etc/fstab

# → Agregar esta línea:
# 192.168.100.57:/home/miguel1/OS3   /home/miguel2/CARPETA_DESTINO   nfs   defaults   0   0

# Verificar montajes activos
df -h

# Reiniciar la máquina cliente para comprobar el montaje automático
sudo reboot

# Verificar nuevamente después del reinicio
df -h


# PRÁCTICA 2 - CONFIGURACIÓN SAMBA

# Servidor Samba
sudo apt install samba -y
adduser samba
addgroup sistema3
usermod -aG sistema3 samba
smbpasswd -a samba
smbpasswd -e samba
mkdir /home/samba/compartida_samba
cd /home/samba
ls -l
chown -R root:sistema3 compartida_samba
chmod -R 777 compartida_samba
touch compartida_samba/ADRIAN{1..100}.txt
ls
sudo nano /etc/samba/smb.conf
sudo systemctl restart smbd

# Cliente Samba
# Acceder desde explorador: \\192.168.100.57
chown -R root:sistema3 compartida_samba
chmod -R 777 compartida_samba
cat /home/samba/compartida_samba

# PRÁCTICA 3 - DOMAIN CONTROLLER

# Actualizar sistema
sudo apt update && sudo apt upgrade -y

# Configurar hostname
sudo hostnamectl set-hostname dc01.miguel.local

# Verificar hostname
hostname

# Identificar adaptador de red
ip link show | grep "state UP" | awk -F: '{print $2}' | tr -d ' '

# Configurar netplan
sudo nano /etc/netplan/00-installer-config.yaml
sudo netplan apply

# Configurar hosts
sudo nano /etc/hosts
# Agregar:
# 127.0.0.1 localhost
# 192.168.100.10 dc01.miguel.local dc01

# Solución para errores de DNS
sudo systemctl stop systemd-resolved
sudo systemctl disable systemd-resolved
sudo systemctl mask systemd-resolved
sudo rm -f /etc/resolv.conf
sudo touch /etc/resolv.conf
sudo chmod 644 /etc/resolv.conf
sudo nano /etc/resolv.conf
# Escribir:
# nameserver 8.8.8.8
# nameserver 1.1.1.1

# Instalar paquetes necesarios
sudo apt install -y samba samba-ad-dc smbclient winbind libnss-winbind libpam-winbind krb5-user krb5-config dnsutils

# Eliminar posibles conflictos
sudo apt remove --purge bind9 bind9utils -y
sudo pkill -9 named
sudo pkill -9 dnsmasq

# Verificar puerto 53 libre
sudo ss -tulpn | grep :53

# Configurar Kerberos
sudo cp /var/lib/samba/private/krb5.conf /etc/krb5.conf

# Configurar DNS definitivo
sudo nano /etc/resolv.conf
# Escribir:
# nameserver 127.0.0.1
# nameserver 8.8.8.8
# search miguel.local
# domain miguel.local

# Hacer inmutable para evitar cambios
sudo chattr +i /etc/resolv.conf

# Iniciar servicios
sudo systemctl enable samba-ad-dc
sudo systemctl start samba-ad-dc

# REINICIAR LA MÁQUINA
sudo reboot

# Verificar estado después del reinicio
sudo systemctl status samba-ad-dc

# Verificar DNS
nslookup miguel.local
nslookup dc01.miguel.local

# Verificar Kerberos
kinit Administrator@MIGUEL.LOCAL
# Contraseña: AdminPassword123!
klist

# Verificar usuarios
sudo samba-tool user list

# Información del dominio
sudo samba-tool domain info 127.0.0.1

# Para unir equipos Windows al dominio usar:
# Add-Computer -DomainName "MIGUEL.LOCAL" -Credential

